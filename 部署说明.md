# Ubuntu 翻译服务一键部署说明

## 🚀 快速开始

### 1. 准备工作

确保你的Ubuntu服务器满足以下要求：
- Ubuntu 18.04+ 
- 至少2GB内存
- 至少10GB可用磁盘空间
- 具有sudo权限的用户

### 2. 上传项目文件

将你的项目文件上传到服务器的任意目录，例如：

```bash
# 方法1: 使用scp上传
scp -r /path/to/your/project user@your-server:~/

# 方法2: 使用git克隆
git clone your-repo-url ~/translation-project

# 方法3: 直接在服务器上创建目录并上传文件
```

### 3. 运行一键部署脚本

```bash
# 进入项目目录
cd ~/your-project-directory

# 给脚本执行权限
chmod +x deploy-ubuntu.sh

# 运行部署脚本
sudo ./deploy-ubuntu.sh
```

### 4. 按提示输入配置信息

脚本会提示你输入以下信息：

1. **Redis密码**: 留空将自动生成随机密码
2. **百度翻译APP ID**: 必须填写你的百度翻译API的APP ID
3. **百度翻译SECRET KEY**: 必须填写你的百度翻译API的密钥
4. **域名**: 可选，留空将使用IP访问

## 📁 部署结构

部署完成后，项目将安装在以下位置：

```
/home/translation-service/          # 项目根目录
├── main.py                         # 主应用文件
├── config.py                       # 配置管理
├── cache.py                        # 缓存管理
├── translator.py                   # 翻译服务
├── static/                         # 静态文件
├── venv/                          # Python虚拟环境
├── .env                           # 环境配置文件
├── gunicorn.conf.py               # Gunicorn配置
└── manage.sh                      # 管理脚本

/var/log/translation-service/       # 日志目录
├── access.log                     # 访问日志
└── error.log                      # 错误日志
```

## 🔧 服务管理

### 使用systemctl命令

```bash
# 启动服务
sudo systemctl start translation-service

# 停止服务
sudo systemctl stop translation-service

# 重启服务
sudo systemctl restart translation-service

# 查看服务状态
sudo systemctl status translation-service

# 查看服务日志
sudo journalctl -u translation-service -f

# 开机自启动
sudo systemctl enable translation-service

# 禁用开机自启动
sudo systemctl disable translation-service
```

### 使用管理脚本

```bash
# 进入项目目录
cd /home/translation-service

# 使用管理脚本
./manage.sh start      # 启动服务
./manage.sh stop       # 停止服务
./manage.sh restart    # 重启服务
./manage.sh status     # 查看状态
./manage.sh logs       # 查看日志
./manage.sh test       # 测试API功能
```

## 🌐 访问服务

部署完成后，你可以通过以下方式访问服务：

### 直接访问API (端口9000)
```bash
# 健康检查
curl http://your-server-ip:9000/health

# 翻译测试
curl -X POST "http://your-server-ip:9000/api/translate" \
  -H "Content-Type: application/json" \
  -d '{"text":"Hello World","from_lang":"en","to_lang":"zh"}'
```

### 通过Nginx代理 (端口80)
```bash
# 健康检查
curl http://your-server-ip/health

# 翻译测试
curl -X POST "http://your-server-ip/api/translate" \
  -H "Content-Type: application/json" \
  -d '{"text":"Hello World","from_lang":"en","to_lang":"zh"}'
```

### 浏览器访问
- 主页: `http://your-server-ip/`
- 健康检查: `http://your-server-ip/health`
- API文档: `http://your-server-ip/docs`

## 🔄 更新部署

### 方法1: 使用快速部署脚本

```bash
# 在项目源码目录中运行
chmod +x quick-deploy.sh
sudo ./quick-deploy.sh
```

### 方法2: 手动更新

```bash
# 停止服务
sudo systemctl stop translation-service

# 备份配置
sudo cp /home/translation-service/.env /tmp/.env.backup

# 更新代码
sudo cp -r /path/to/new/code/* /home/translation-service/

# 恢复配置
sudo cp /tmp/.env.backup /home/translation-service/.env

# 更新依赖
sudo -u translation /home/translation-service/venv/bin/pip install -r /home/translation-service/requirements.txt

# 重启服务
sudo systemctl start translation-service
```

## 🛠️ 故障排除

### 1. 服务启动失败

```bash
# 查看详细错误日志
sudo journalctl -u translation-service --no-pager -l

# 检查配置文件
sudo -u translation /home/translation-service/venv/bin/python -c "import main"

# 检查端口占用
sudo ss -tlnp | grep :9000
```

### 2. Redis连接问题

```bash
# 检查Redis状态
sudo systemctl status redis-server

# 测试Redis连接
redis-cli -a your_redis_password ping

# 查看Redis配置
sudo cat /etc/redis/redis.conf | grep requirepass
```

### 3. Nginx代理问题

```bash
# 检查Nginx状态
sudo systemctl status nginx

# 测试Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

### 4. 权限问题

```bash
# 修复文件权限
sudo chown -R translation:translation /home/translation-service
sudo chmod -R 755 /home/translation-service
```

## 📊 监控和日志

### 查看实时日志

```bash
# 应用日志
sudo tail -f /var/log/translation-service/error.log
sudo tail -f /var/log/translation-service/access.log

# 系统日志
sudo journalctl -u translation-service -f

# Nginx日志
sudo tail -f /var/log/nginx/translation-error.log
sudo tail -f /var/log/nginx/translation-access.log
```

### 性能监控

```bash
# 查看进程状态
ps aux | grep gunicorn

# 查看端口连接
sudo ss -tlnp | grep :9000

# 查看系统资源
htop
free -h
df -h
```

## 🔒 安全配置

### 防火墙设置

脚本会自动配置UFW防火墙，开放以下端口：
- 22 (SSH)
- 80 (HTTP)
- 443 (HTTPS)

### SSL证书配置 (可选)

如果你有域名，可以配置免费的Let's Encrypt SSL证书：

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

## 📞 技术支持

如果遇到问题，请按以下步骤排查：

1. 检查服务状态: `sudo systemctl status translation-service`
2. 查看错误日志: `sudo journalctl -u translation-service --no-pager -l`
3. 测试API连接: `curl http://localhost:9000/health`
4. 检查配置文件: `/home/translation-service/.env`
5. 验证依赖安装: `/home/translation-service/venv/bin/pip list`

## 📝 配置文件说明

主要配置文件位于 `/home/translation-service/.env`：

```bash
# Redis配置
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=your_password

# 百度翻译API
BAIDU_APP_ID=your_app_id
BAIDU_SECRET_KEY=your_secret_key

# 应用配置
DEBUG=false
LOG_LEVEL=INFO
```

修改配置后需要重启服务：
```bash
sudo systemctl restart translation-service
```
